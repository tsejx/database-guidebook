<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/database-guidebook/umi.3dfdd0be.css" />
    <script>
      window.routerBase = "/database-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>聚合管道 - Database Guidebook</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/mongodb/basic/aggregation" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/database-guidebook.png&#x27;)" href="/database-guidebook//">Database Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/database-guidebook//basic">基础</a></span><span><a href="/database-guidebook//sql">SQL</a></span><span><a aria-current="page" class="active" href="/database-guidebook//mongodb">MongoDB</a></span><span><a href="/database-guidebook//redis">Radis</a></span><span><a href="/database-guidebook//extensions">扩展</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/database-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/database-guidebook.png&#x27;)" href="/database-guidebook//"></a><h1>Database Guidebook</h1><p>Database 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/database-guidebook//basic">基础</a></li><li><a href="/database-guidebook//sql">SQL</a></li><li><a aria-current="page" class="active" href="/database-guidebook//mongodb">MongoDB</a></li><li><a href="/database-guidebook//redis">Radis</a></li><li><a href="/database-guidebook//extensions">扩展</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/database-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">基本概述</a><ul><li><a href="/database-guidebook//mongodb/overview/basic"><span>基本概述</span></a></li><li><a href="/database-guidebook//mongodb/overview/installment"><span>安裝使用</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">高阶应用</a><ul><li><a href="/database-guidebook//mongodb/advanced/authentication"><span>鉴权</span></a></li><li><a href="/database-guidebook//mongodb/advanced/backup-and-recovery"><span>备份与恢复</span></a></li><li><a href="/database-guidebook//mongodb/advanced/replication"><span>数据库副本集</span></a></li><li><a href="/database-guidebook//mongodb/advanced/security"><span>数据库安全</span></a></li><li><a href="/database-guidebook//mongodb/advanced/sharding"><span>数据库分片</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Mongoose</a><ul><li><a href="/database-guidebook//mongodb/mongoose/overview"><span>概述</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/connections"><span>连接 Connections</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/schema-types"><span>模式类型 SchemaTypes</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/model-api"><span>Model</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/queries"><span>普通查询</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/populate"><span>填充查询</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/aggregate"><span>聚合查询</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/hooks"><span>钩子函数</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/middleware"><span>中间件 Middleware</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/plugins"><span>插件</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/validation"><span>验证</span></a></li><li><a href="/database-guidebook//mongodb/mongoose/basic"><span>集成</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">基本操作</a><ul><li><a href="/database-guidebook//mongodb/basic/documents"><span>文档 Documents</span></a></li><li><a href="/database-guidebook//mongodb/other/command"><span>命令大全</span></a></li><li><a href="/database-guidebook//mongodb/basic/models"><span>模型 Models</span></a></li><li><a href="/database-guidebook//mongodb/other/utils"><span>工具大全</span></a></li><li><a href="/database-guidebook//mongodb/basic/schemas"><span>模式 Schema</span></a></li><li><a href="/database-guidebook//mongodb/basic/indexes"><span>数据库索引</span></a></li><li><a href="/database-guidebook//mongodb/basic/models-relationship"><span>数据模型关联</span></a></li><li><a aria-current="page" class="active" href="/database-guidebook//mongodb/basic/aggregation"><span>聚合管道</span></a></li><li><a href="/database-guidebook//mongodb/basic/subdocuments"><span>子文档 Subdocuments</span></a></li><li><a href="/database-guidebook//mongodb/other/mongodb"><span>扩展资料</span></a></li></ul></li><li><a href="/database-guidebook//mongodb/overview">基本概述</a><ul><li><a href="/database-guidebook//mongodb/overview/administration"><span>数据库管理</span></a></li><li><a href="/database-guidebook//mongodb/overview/configuration"><span>配置文件</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="聚合框架" data-depth="2"><a href="/database-guidebook//mongodb/basic/aggregation#聚合框架"><span>聚合框架</span></a></li><li title="聚合表达式" data-depth="2"><a href="/database-guidebook//mongodb/basic/aggregation#聚合表达式"><span>聚合表达式</span></a></li><li title="字段路径表达式" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#字段路径表达式"><span>字段路径表达式</span></a></li><li title="系统变量表达式" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#系统变量表达式"><span>系统变量表达式</span></a></li><li title="常量表达式" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#常量表达式"><span>常量表达式</span></a></li><li title="表达式操作符" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#表达式操作符"><span>表达式操作符</span></a></li><li title="聚合管道阶段" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#聚合管道阶段"><span>聚合管道阶段</span></a></li><li title="配置项" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#配置项"><span>配置项</span></a></li><li title="聚合操作的优化" data-depth="2"><a href="/database-guidebook//mongodb/basic/aggregation#聚合操作的优化"><span>聚合操作的优化</span></a></li><li title="顺序优化" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#顺序优化"><span>顺序优化</span></a></li><li title="合并优化" data-depth="3"><a href="/database-guidebook//mongodb/basic/aggregation#合并优化"><span>合并优化</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="聚合管道"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#聚合管道"><span class="icon icon-link"></span></a>聚合管道</h1><p>先介绍管道的概念，在 POSIX 多线程的使用方式中，定义了一种重要的 pipeline 方式，成为 <strong>流水线</strong> 或 <strong>管道</strong>，这种方式使得数据被一组线程顺序执行。</p><div class="__dumi-default-code-block"><pre class="prism-code language-unknown"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">Input -&gt; ThreadA -&gt; ThreadB -&gt; ThreadC -&gt; Output</span></div></pre></div><p>以面向对象的思想去理解，整个流水线，可以理解为一个数据传输的管道；该管道中的每一个工作线程，可以理解为一个整个流水线的一个工作阶段 stage，这些工作线程之间的合作是一环扣一环的。靠输入口越近的工作线程，是时序较早的工作阶段 stage，它的工作成果会影响下一个工作线程阶段（stage）的工作结果，即下个阶段依赖于上一个阶段的输出，上一个阶段的输出成为本阶段的输入。这也是 pipeline 的一个共有特点。</p><h2 id="聚合框架"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#聚合框架"><span class="icon icon-link"></span></a>聚合框架</h2><p>Mongodb 在 2.2 版本中引入了 <strong>聚合框架</strong>（aggregate framework）的新功能，它是聚合的新框架，其概念类似于数据处理的管道，每个文档经过一个由多个节点组成的管道，每个节点相当于流水线中的一个 stage，有自己的功能（分组、过滤等），文档经过管道处理后，最后输出相应的结果，管道的基本功能有两个：</p><ol><li>对文档进行<strong>过滤</strong>，筛选出合适的文档</li><li>对文档进行<strong>变换</strong>，改变文档的输出形式</li></ol><p>其他的一些功能还包括按照某个指定的字段分组和排序等。而且在每个阶段还可以使用表达式操作符计算平均值和拼接字符串等相关操作。</p><p>管道提供了一个 MapReduce 的替代方案，MapReduce 使用相对来说比较复杂，而管道的拥有固定的接口（操作符表达），使用比较简单，对于大多数的聚合任务管道一般来说是首选方法。</p><p>MongoDB 中的聚合主要用于简单的数据处理（平均值，求和等），并返回计算后的数据结果，类似于 SQL 中的内嵌函数（<code>count()</code> 等）。</p><p>🌰 MongoDB 官网给出了聚合框架的应用实例：</p></div><img src="/database-guidebook/static/mongodb-aggregation.d9fbbcf4.jpg" width="720"/><div class="markdown"><h2 id="聚合表达式"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#聚合表达式"><span class="icon icon-link"></span></a>聚合表达式</h2><h3 id="字段路径表达式"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#字段路径表达式"><span class="icon icon-link"></span></a>字段路径表达式</h3><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>字段路径表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$&lt;field&gt;</code></td><td>使用 <code>$</code> 来指示字段路径</td></tr><tr><td><code>$&lt;field&gt;.&lt;sub-field&gt;</code></td><td>使用 <code>$</code> 和 <code>.</code> 来指示内嵌文档字段路径</td></tr></tbody></table></div></div><h3 id="系统变量表达式"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#系统变量表达式"><span class="icon icon-link"></span></a>系统变量表达式</h3><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>系统变量表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$$&lt;variable&gt;</code></td><td>使用 <code>$$</code> 来指示系统变量</td></tr><tr><td><code>$$CURRENT</code></td><td>指示管道中当前操作的文档</td></tr></tbody></table></div></div><h3 id="常量表达式"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#常量表达式"><span class="icon icon-link"></span></a>常量表达式</h3><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>常量表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$literal: &lt;value&gt;</code></td><td>指示常量 <code>&lt;value&gt;</code></td></tr><tr><td><code>$literal: &quot;$name&quot;</code></td><td>指示常量字符串 &quot;<span class="math math-inline"><mjx-container className="MathJax" jax="SVG"><svg style="vertical-align:-0.566ex" xmlns="http://www.w3.org/2000/svg" width="23.405ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 10345.1 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-I-1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path><path id="MJX-1-TEX-I-1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-I-1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path><path id="MJX-1-TEX-N-2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"></path><path id="MJX-1-TEX-N-3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path><path id="MJX-1-TEX-I-1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path><path id="MJX-1-TEX-I-1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path><path id="MJX-1-TEX-N-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path><path id="MJX-1-TEX-N-3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path><path id="MJX-1-TEX-N-2035" d="M12 501Q12 527 31 542T63 558Q73 560 77 560Q114 560 128 528Q133 518 188 293T244 61Q244 56 223 50T195 43Q192 43 190 45T102 263T14 486Q12 496 12 501Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D45B" xlink:href="#MJX-1-TEX-I-1D45B"></use></g><g data-mml-node="mi" transform="translate(600,0)"><use data-c="1D44E" xlink:href="#MJX-1-TEX-I-1D44E"></use></g><g data-mml-node="mi" transform="translate(1129,0)"><use data-c="1D45A" xlink:href="#MJX-1-TEX-I-1D45A"></use></g><g data-mml-node="mi" transform="translate(2007,0)"><use data-c="1D452" xlink:href="#MJX-1-TEX-I-1D452"></use></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2473,0)"><g data-mml-node="mo"><g data-c="2033"><use data-c="2032" xlink:href="#MJX-1-TEX-N-2032"></use><use data-c="2032" xlink:href="#MJX-1-TEX-N-2032" transform="translate(275,0)"></use></g></g></g><g data-mml-node="mo" transform="translate(3300.8,0)"><use data-c="3C" xlink:href="#MJX-1-TEX-N-3C"></use></g><g data-mml-node="mi" transform="translate(4356.6,0)"><use data-c="1D44F" xlink:href="#MJX-1-TEX-I-1D44F"></use></g><g data-mml-node="mi" transform="translate(4785.6,0)"><use data-c="1D45F" xlink:href="#MJX-1-TEX-I-1D45F"></use></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5236.6,0)"><g data-mml-node="mo"><use data-c="2F" xlink:href="#MJX-1-TEX-N-2F"></use></g></g><g data-mml-node="mo" transform="translate(6014.3,0)"><use data-c="3E" xlink:href="#MJX-1-TEX-N-3E"></use></g><g data-mml-node="mi" transform="translate(7070.1,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">这</text></g><g data-mml-node="mi" transform="translate(8070.1,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">里</text></g><g data-mml-node="mi" transform="translate(9070.1,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mo" transform="translate(10070.1,0)"><use data-c="2035" xlink:href="#MJX-1-TEX-N-2035"></use></g></g></g></svg></mjx-container></span>` 被当作常量处理，而不是字段路径表达式</td></tr></tbody></table></div></div><h3 id="表达式操作符"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#表达式操作符"><span class="icon icon-link"></span></a>表达式操作符</h3><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>常用表达式</th><th>说明</th></tr></thead><tbody><tr><td><code>$sum</code></td><td>计算总和，<code>{<!-- -->$sum: 1<!-- -->}</code> 表示返回总和 x 1 的值，使用 <code>{<!-- --> $sum: &#x27;$指定字段&#x27; <!-- -->}</code> 也能直接获取指定字段的值的总和</td></tr><tr><td><code>$avg</code></td><td>求平均值</td></tr><tr><td><code>$min</code></td><td>求最小值</td></tr><tr><td><code>$max</code></td><td>求最大值</td></tr><tr><td><code>$push</code></td><td>将结果文档中插入值到一个数组中</td></tr><tr><td><code>$first</code></td><td>根据文档的排序获取第一个文档数据</td></tr><tr><td><code>$last</code></td><td>同理，获取最后一个文档数据</td></tr></tbody></table></div></div><h3 id="聚合管道阶段"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#聚合管道阶段"><span class="icon icon-link"></span></a>聚合管道阶段</h3><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th>聚合管道表达式</th><th>说明</th><th>MySQL 操作/函数</th></tr></thead><tbody><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#project"><code>$project</code></a></td><td>对输入文档进行再次投影</td><td>where</td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#match"><code>$match</code></a></td><td>对输入文档进行筛选</td><td>having</td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#limit-%E5%92%8C-skip"><code>$limit</code></a></td><td>筛选出管道内前 N 篇文档</td><td>limit</td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#limit-%E5%92%8C-skip"><code>$skip</code></a></td><td>跳过管道内前 N 篇文档</td><td></td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#skip"><code>$unwind</code></a></td><td>展开输入文档中的数组字段</td><td></td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#sort"><code>$sort</code></a></td><td>对输入文档进行排序</td><td>order by</td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#lookup"><code>$lookup</code></a></td><td>对输入文档进行查询操作</td><td>join</td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#group"><code>$group</code></a></td><td>对输入文档进行分组</td><td>group by</td></tr><tr><td><a href="/database-guidebook//mongodb/basic/aggregation#out"><code>$out</code></a></td><td>将管道中的文档输出</td><td></td></tr></tbody></table></div></div><h4 id="project"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#project"><span class="icon icon-link"></span></a>$project</h4><p><code>$project</code> 管道操作符用于修改流中的文档。</p><p>对文档进行重新投影，主要用于<strong>重命名</strong>、<strong>增加字字段</strong>、<strong>删除字段</strong>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 隐藏文档 class 主键，显示 age 字段值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 添加新字段 name，值为原文档中字段 info 中的 name 的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$project</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token number">0</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      age: </span><span class="token number">1</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      name: </span><span class="token string">&quot;</span><span class="token string variable">$info</span><span class="token string">.name&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 同样地，隐藏文档 class 主键，显示 age 字段值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 添加新字段 sub，其数据类型为数组，也以对应 subject 的对象键值填充</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 当不存在字段，会使用 null 填充</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$project</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token number">0</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      age: </span><span class="token number">1</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      sub: </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;</span><span class="token string variable">$subject</span><span class="token string">.chinese&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;</span><span class="token string variable">$subject</span><span class="token string">.maths&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;</span><span class="token string variable">$subject</span><span class="token string">.english&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><p><code>$project</code> 是很常用的聚合阶段，可以用来灵活地控制输出文档的格式，也可以用来提出不相关的字段，以优化聚合管道操作的性能。</p><h4 id="match"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#match"><span class="icon icon-link"></span></a>$match</h4><p><code>$match</code> 中使用的<strong>文档筛选语法</strong>，和读取文档时的 <code>$match</code> 语法相同。主要用于过滤、筛选符合条件的文档，作为下一阶段的输入。</p><p>⚠️ <strong>注意</strong>：由于 <code>aggregate</code> 管道对于内存的限制，在处理大文件的时候，最好先用 <code>$match</code> 操作符进行筛选，减少内存占用。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 匹配 class 文档字段（嵌套文档） &lt;field&gt; 的字段 &lt;sub-field&gt; 的值为 &lt;value&gt; 的文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&quot;&lt;field&gt;.&lt;sub-field&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">$ db.class.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token variable">$or</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">comparasion-operator</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">comparasion-operator</span><span class="token operator file-descriptor important">2</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">2</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">           </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain">, </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token string">&quot;&lt;field2&gt;.&lt;sub-field2&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">3</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&quot;&lt;field&gt;.&lt;sub-field&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><p><code>$match</code> 常常用于剔除或保留某篇文档。应该尽量在聚合管道的开始阶段应用 <code>$match</code>，这样可以减少后续阶段中需要处理的文档数量，优化聚合操作的性能。</p><p>⚠️ <strong>注意事项：</strong></p><ul><li>不能在 <code>$match</code> 操作符中使用 <code>$where</code> 表达式操作符</li><li><code>$match</code> 应该尽可能在管道查询的前置阶段，可以提早过滤文档，减少后续阶段操作文档，加快聚合速度</li><li>如果 <code>$match</code> 出现在最前面的话，可以使用索引来加快查询</li></ul><h4 id="limit-和-skip"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#limit-和-skip"><span class="icon icon-link"></span></a>limit 和 skip</h4><p><code>$limt</code> 和 <code>$skip</code> 通常在一起使用。</p><p><code>$limit</code> 用于限制经过管道的文档的数量。</p><p><code>$skip</code> 用于待操作集合处理前跳过部分的文档。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 筛选 &lt;number&gt; 篇文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$limit</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">number</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 跳过 &lt;number&gt; 篇文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$skip</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">number</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><h4 id="unwind"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#unwind"><span class="icon icon-link"></span></a>$unwind</h4><p>将数组拆分成独立字段。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 如果原文档中对应的 &lt;field&gt; 字段是数组，那么就会将数组中每个元素，生成新的文档，对应的 &lt;field&gt; 为展开的数组成员</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 新生成的文档文档主键都是一致的，区别在于 &lt;field&gt; 的不同</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果原文档中对应的 &lt;field&gt; 字段为非数组，那么不会有其他操作，直接保留下来</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;$&lt;field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 同上，但是展开后会添加一个新字段 &lt;field-item-index&gt;，为原文档数组中的索引数值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果原文档对应 &lt;field&gt; 不是数组类型，新增的字段默认填充 null</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;$&lt;field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      includArrayIndex: </span><span class="token operator">&lt;</span><span class="token plain">field-item-index</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 展开数组时保留空数组或不存在数组的文档</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;$&lt;field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      preserveNullAndEmptyArrays: </span><span class="token boolean">true</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><h4 id="sort"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#sort"><span class="icon icon-link"></span></a>$sort</h4><p>对文档按照指定字段排序，与查询文档 <code>find()</code> 时的 <code>sort</code> 相同。</p><ul><li><code>1</code>：由小到大</li><li><code>-1</code>：由大到小</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 对文档进行排序</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$sort</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">sort-number</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token string">&quot;&lt;field2&gt;.&lt;sub-field&gt;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">sort-number</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><h4 id="lookup"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#lookup"><span class="icon icon-link"></span></a>$lookup</h4><h5 id="使用单一字段值进行查询"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#使用单一字段值进行查询"><span class="icon icon-link"></span></a>使用单一字段值进行查询</h5><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 同一数据库中的另一个查询集合（不能跨数据库查询）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  from: </span><span class="token operator">&lt;</span><span class="token plain">collection to join</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 管道文档中用来查询的字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  localField: </span><span class="token operator">&lt;</span><span class="token plain">field from the input docuement</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 查询集合中的查询字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  foreignField: </span><span class="token operator">&lt;</span><span class="token plain">field from the documents of the </span><span class="token string">&quot;from&quot;</span><span class="token plain"> collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 写入管道文档中的查询结果数组字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  as: </span><span class="token operator">&lt;</span><span class="token plain">output array field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>如下面代码所示：</p><p>MongoDB 会先管道查询 <code>&lt;aggregation-collection&gt;</code> 集合（这里我们称为管道集合），同时也会查询另一个集合 <code>&lt;find-collection&gt;</code>（这里我们称为查询集合）。当管道集合文档中的字段 <code>&lt;aggregation-field&gt;</code> 与查询集合文档中的字段 <code>&lt;find-field&gt;</code> 相匹配时，这篇查询集合中的文档就是符合查询条件的文档，那么就会将这篇文档添加到管道集合对应文档的 <code>&lt;new-field&gt;</code> 字段中。而 <code>&lt;new-field&gt;</code> 的内容就根据查询结果而有所不同，</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token string">&quot;&lt;find-collection&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      localField: </span><span class="token string">&quot;&lt;aggregation-field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      foreignField: </span><span class="token string">&quot;&lt;find-field&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token string">&quot;&lt;new-field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><ul><li>如果管道集合的 <code>&lt;local-field&gt;</code> 字段是个数组字段，查询集合的 <code>&lt;find-field&gt;</code> 字段是字符串字段，<code>&lt;local-field&gt;</code> 多个成员与查询集合中的 <code>&lt;find-field&gt;</code> 相匹配，那么会将查询集合中这几个字段匹配的文档组成数组，赋值到管道集合文档的 <code>&lt;new-field&gt;</code> 新字段中。</li><li>如果都没有对应符合条件的 <code>&lt;find-collection&gt;</code> 文档，那么 <code>&lt;aggregation-collection&gt;</code> 的文档也会保留下来，但是 <code>&lt;new-field&gt;</code> 字段会是空数组</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 如果 localField 是一个数组字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 使用 $unwind 将 &lt;aggregation-collection&gt; 的 &lt;aggregation-field&gt; 数组字段展开</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$unwind</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      path: </span><span class="token string">&quot;$&lt;aggregation-field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token operator">&lt;</span><span class="token plain">find-collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      localField: </span><span class="token operator">&lt;</span><span class="token plain">aggregation-field</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      foreignField: </span><span class="token operator">&lt;</span><span class="token plain">find-field</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><p>先经过 <code>$unwind</code> 会先把管道集合中 <code>&lt;aggregation-collection&gt;</code> 文档中无法展开的 <code>&lt;aggregation-field&gt;</code> 字段的值的对应文档剔除。</p><h5 id="使用复杂条件进行查询"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#使用复杂条件进行查询"><span class="icon icon-link"></span></a>使用复杂条件进行查询</h5><p><code>let</code> 是在对 <code>pipeline</code> 进行进一步聚合查询时需要用到原管道查询时使用到的文档的字段值时使用的，是用于对原管道查询时所在文档的字段进行再次声明。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  from: </span><span class="token operator">&lt;</span><span class="token plain">collection to join</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 对查询集合中的文档使用聚合阶段进行处理时，如果需要参考管道文档中的字段，则必须使用 let 参数对字段进行声明</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  let: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">var_1: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator">&gt;</span><span class="token plain">, </span><span class="token punctuation">..</span><span class="token plain">., </span><span class="token operator">&lt;</span><span class="token plain">var_n</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 对查询集合中的文档使用聚合阶段进行查询（针对 from 指定的集合中的文档）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  pipeline: </span><span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token plain">pipeline to execute on the collection to join</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">	as: </span><span class="token operator">&lt;</span><span class="token plain">output array field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>🌰 <strong>示例：</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 对 &lt;find-collection&gt; 以 $match 做筛选做示例</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token operator">&lt;</span><span class="token plain">find-collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      pipeline: </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># &lt;find-collection-field&gt; 查询集合中文档的字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># &lt;var-aggregation-field&gt; 是原文档重新声明的字段（相当于一个间接变量）</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">aggregation-collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$lookup</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      from: </span><span class="token operator">&lt;</span><span class="token plain">find-collection</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      let: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">var-aggregation-field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token string">&quot;$&lt;aggregation-field&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># pipeline 中所有聚合管道阶段都是应用在查询集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      pipeline: </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token variable">$match</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token variable">$expr</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token variable">$and</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$eq</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;$&lt;find-collection-field&gt;&quot;</span><span class="token plain">, </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">                </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$gt</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$$</span><span class="token string">&lt;var-aggregation-field&gt;&quot;</span><span class="token plain">, </span><span class="token operator">&lt;</span><span class="token plain">value</span><span class="token operator file-descriptor important">2</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">              </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">]</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      as: </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><h4 id="group"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#group"><span class="icon icon-link"></span></a>$group</h4><p>使用 <code>$group</code> 操作符必须指定 <code>_id</code> 域，同时也可以包含一些算术类型的表达式操作符。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 定义分组规则</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  _id: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator">&gt;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token comment"># 可以使用聚合操作符来定义新字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token operator">&lt;</span><span class="token plain">field</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">accumulator</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token operator">&lt;</span><span class="token plain">expression</span><span class="token operator file-descriptor important">1</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">..</span><span class="token plain">.</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>🌰 <strong>示例：</strong></p><p>通过管道集合的 <code>&lt;collection-field&gt;</code> 字段对数据进行分组。</p><p>不实用聚合操作符的情况下，<code>$group</code> 可以返回管道文档中某一字段的所有（不重复的）值。</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 基本使用方法</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token string">&quot;$&lt;collection-field&gt;&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><p>下面以实际例子演示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 高级用法，使用聚合操作符计算分组聚合值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 赋值为 null 时，不会分组，所有管道文档分为一组</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token string">&quot;</span><span class="token string variable">$currency</span><span class="token string">&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档的 qty 字段求和结果，赋值 totalQty 新字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      totalQty: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档的 price 和 qty 的乘积的求和结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      totalNotional: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$multiply</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain">, </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档的 price 字段求得平均数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      avgPrice: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$avg</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 每篇文档 +1，多少篇就加多少次，集合文档的总数</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      count: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$sum</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># 找到分组中某个表达式中最大的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      maxNotional: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$max</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$multiply</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain">, </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">#找到分组中某个表达式中最小的值</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      minNotional: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$min</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$multiply</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$price</span><span class="token string">&quot;</span><span class="token plain">, </span><span class="token string">&quot;</span><span class="token string variable">$qty</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><p>⚠️ <strong>注意事项：</strong></p><ul><li><code>$group</code> 的输出是无序的</li><li><code>$group</code> 操作目前是在内存中进行的，所以不能用它来对大量个数的文档进行分类</li><li>必须指定 <code>_id</code> 域</li></ul><h4 id="out"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#out"><span class="icon icon-link"></span></a>$out</h4><p>创建指定副本集合</p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ db.</span><span class="token operator">&lt;</span><span class="token plain">collection</span><span class="token operator">&gt;</span><span class="token plain">.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      _id: </span><span class="token string">&quot;$&lt;field1&gt;&quot;</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">      </span><span class="token comment"># &lt;field2&gt; 是数组字段</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">new-field</span><span class="token operator">&gt;</span><span class="token plain">: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$push</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;$&lt;field2&gt;&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment"># 副本集合名称</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token variable">$out</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;output&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span></div></pre></div><p>🌰 <strong>实例：</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-bash"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment"># 已有集合</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">8751</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;The Banquet&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">8752</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Divine Comedy&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">8645</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Eclogues&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">7000</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;The Odyssey&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Homer&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">7020</span><span class="token plain">, </span><span class="token string">&quot;title&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Iliad&quot;</span><span class="token plain">, </span><span class="token string">&quot;author&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Homer&quot;</span><span class="token plain">, </span><span class="token string">&quot;copies&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 按照 author 分组，然后 out 一个新集合 authors</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">$ db.books.aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$group</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> _id: </span><span class="token string">&quot;</span><span class="token string variable">$author</span><span class="token string">&quot;</span><span class="token plain">, books: </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$push</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;</span><span class="token string variable">$title</span><span class="token string">&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain">,</span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token variable">$out</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;authors&quot;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 查询结果</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Homer&quot;</span><span class="token plain">, </span><span class="token string">&quot;books&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;The Odyssey&quot;</span><span class="token plain">, </span><span class="token string">&quot;Iliad&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token string">&quot;_id&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string">&quot;Dante&quot;</span><span class="token plain">, </span><span class="token string">&quot;books&quot;</span><span class="token plain"> </span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"> </span><span class="token string">&quot;The Banquet&quot;</span><span class="token plain">, </span><span class="token string">&quot;Divine Comedy&quot;</span><span class="token plain">, </span><span class="token string">&quot;Eclogues&quot;</span><span class="token plain"> </span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span></div></pre></div><h3 id="配置项"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#配置项"><span class="icon icon-link"></span></a>配置项</h3><p>每个聚合管道阶段使用的内存不能超过 100MB。</p><p>如果数据量较大，为了防止聚合管道阶段超出内存上限并且抛出错误，可以启用 <code>allowDiskUse</code> 选项。</p><p><code>allowDishUse</code> 启用之后，聚合阶段可以再内存容量不足时，将操作数据写入临时文件中。</p><p>临时文件会被写入 <code>dbPath</code> 下的 <code>_tmp</code> 文件夹，<code>dbPath</code> 的默认值为 <code>/data/db</code>。</p><h2 id="聚合操作的优化"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#聚合操作的优化"><span class="icon icon-link"></span></a>聚合操作的优化</h2><h3 id="顺序优化"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#顺序优化"><span class="icon icon-link"></span></a>顺序优化</h3><h4 id="project--match"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#project--match"><span class="icon icon-link"></span></a><code>$project</code> + <code>$match</code></h4><p>既需要使用 <code>$project</code>，也需要 <code>$match</code> 阶段，MongoDB 在运行聚合管道代码时，尽量把 <code>$match</code> 阶段设置在 <code>$project</code> 阶段之前运行。因为 <code>$match</code> 是对文档进行筛选，所以 <code>$match</code> 阶段很有可能减少文档数量，那么如果我们要尽量减少操作量，那么就需要尽可能早地阶段减少文档进入后续的阶段。</p><h4 id="sort--match"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#sort--match"><span class="icon icon-link"></span></a><code>$sort</code> + <code>$match</code></h4><p>同理，把 <code>$match</code> 提前到 <code>$sort</code> 阶段前，能有效优化。</p><h4 id="project--skip"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#project--skip"><span class="icon icon-link"></span></a><code>$project</code> + <code>$skip</code></h4><p><code>$skip</code> 阶段在 <code>$project</code> 阶段之前运行。</p><h3 id="合并优化"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#合并优化"><span class="icon icon-link"></span></a>合并优化</h3><h4 id="sort--limit"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#sort--limit"><span class="icon icon-link"></span></a><code>$sort</code> + <code>$limit</code></h4><p>如果两者之间没有夹杂着改变文档数量的聚合阶段，<code>$sort</code> 和 <code>$limit</code> 阶段可以合并。</p><p>同类型的，如下组合也可以进行优化：</p><ul><li><code>$limit</code> + <code>$limit</code></li><li><code>$skip</code> + <code>$skip</code></li><li><code>$match</code> + <code>$match</code></li></ul><p>连续的 <code>$limit</code>、<code>$skip</code> 或 <code>$skip</code> 阶段排列在一起时，可以合并为一个阶段。</p><h4 id="lookup-和-unwind"><a aria-hidden="true" tabindex="-1" href="/database-guidebook//mongodb/basic/aggregation#lookup-和-unwind"><span class="icon icon-link"></span></a><code>$lookup</code> 和 <code>$unwind</code></h4><p>连续排列在一起的 <code>$lookup</code> 和 <code>$unwind</code> 阶段，如果 <code>$unwind</code> 应用在 <code>$lookup</code> 阶段创建的 <code>as</code> 字段上，则两者可以合并。</p><hr/><p><strong>参考资料：</strong></p><ul><li><p><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/5ba8acb9e51d45395d4ee4d1">MongoDB 聚合管道<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a target="_blank" rel="noopener noreferrer" href="https://www.cnblogs.com/clschen/p/5523897.html">MongoDB 北大绿卡之安全建议<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a target="_blank" rel="noopener noreferrer" href="https://t-baby.gitbooks.io/mongodb-plugin/content/ju_he_yun_suan.html">聚合运算<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a target="_blank" rel="noopener noreferrer" href="https://laixiazheteng.com/article/page/id/Bj7qgmJ3CJUE">MongoDB 常用语句<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li><li><p><a target="_blank" rel="noopener noreferrer" href="https://blog.csdn.net/congcong68/article/details/51620040">学习 MongoDB 聚合 Aggregation Pipeline 基础篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul><p><a target="_blank" rel="noopener noreferrer" href="https://segmentfault.com/a/1190000020685264?utm_source=tag-newest">https://segmentfault.com/a/1190000020685264?utm_source=tag-newest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><ul><li><code>$project</code>：修改输入文档的结构。可以用来重命名、增加或删除域，也可以用于创建计算结果以及嵌套文档。</li><li><code>$match</code>：用于过滤数据，只输出符合条件的文档。$match 使用 MongoDB 的标准查询操作。</li><li><code>$limit</code>：用来限制 MongoDB 聚合管道返回的文档数。</li><li><code>$skip</code>：在聚合管道中跳过指定数量的文档，并返回余下的文档。</li><li><code>$unwind</code>：将文档中的某一个数组类型字段拆分成多条，每条包含数组中的一个值。</li><li><code>$group</code>：将集合中的文档分组，可用于统计结果。</li><li><code>$sort</code>：将输入文档排序后输出。</li><li><code>$geoNear</code>：输出接近某一地理位置的有序文档。</li></ul><p><a target="_blank" rel="noopener noreferrer" href="https://www.jianshu.com/p/968d75f40861">https://www.jianshu.com/p/968d75f40861<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><style>
mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][display="true"][width="full"] {
  display: flex;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line], svg[data-table] > g > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > g > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax="SVG"] path[data-c], mjx-container[jax="SVG"] use[data-c] {
  stroke-width: 3;
}
</style></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/database-guidebook/edit/master/docs/mongodb/basic/aggregation.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">12/15/2023 15:30:17</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/database-guidebook/umi.d7e99dc7.js"></script>
  </body>
</html>
